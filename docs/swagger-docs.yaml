openapi: 3.0.3
info:
  title: Clinica Backend API
  version: 1.0.0
servers:
  - url: http://localhost:3001
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
      example:
        message: "Error"
    ValidationErrorResponse:
      type: object
      properties:
        errors:
          type: object
      example:
        errors:
          formErrors: []
          fieldErrors:
            usr_txt_email:
              - "Invalid email"
    LoginRequest:
      type: object
      required:
        - usr_txt_email
        - usr_txt_password
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        usr_txt_password:
          type: string
          minLength: 1
          maxLength: 100
      example:
        usr_txt_email: "juan.perez@correo.com"
        usr_txt_password: "Password#123"
    LoginResponse:
      type: object
      properties:
        token:
          type: string
        refreshToken:
          type: string
      example:
        token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refreshToken: "r1J2V3Z4Y0p1Qk1i..."
    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
      example:
        refreshToken: "r1J2V3Z4Y0p1Qk1i..."
    RefreshTokenResponse:
      type: object
      properties:
        token:
          type: string
        refreshToken:
          type: string
      example:
        token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refreshToken: "r1J2V3Z4Y0p1Qk1i..."
    MessageResponse:
      type: object
      properties:
        message:
          type: string
      example:
        message: "OK"
    VerifyEmailRequest:
      type: object
      required:
        - usr_txt_email
        - usr_txt_verification_code
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        usr_txt_verification_code:
          type: string
          minLength: 6
          maxLength: 6
      example:
        usr_txt_email: "juan.perez@correo.com"
        usr_txt_verification_code: "123456"
    RequestPasswordResetRequest:
      type: object
      required:
        - usr_txt_email
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
      example:
        usr_txt_email: "juan.perez@correo.com"
    ResetPasswordRequest:
      type: object
      required:
        - usr_txt_email
        - usr_txt_verification_code
        - usr_txt_password
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        usr_txt_verification_code:
          type: string
          minLength: 6
          maxLength: 6
        usr_txt_password:
          type: string
          minLength: 8
          maxLength: 100
          description: "Must include uppercase, lowercase, number, and special character."
      example:
        usr_txt_email: "juan.perez@correo.com"
        usr_txt_verification_code: "123456"
        usr_txt_password: "New#Password1"
    RegisterRequest:
      type: object
      required:
        - usr_txt_email
        - usr_txt_password
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        usr_txt_password:
          type: string
          minLength: 8
          maxLength: 100
          description: "Must include uppercase, lowercase, number, and special character."
      example:
        usr_txt_email: "juan.perez@correo.com"
        usr_txt_password: "Password#123"
    CreateUserRequest:
      type: object
      required:
        - usr_txt_email
        - roles
        - usr_txt_password
        - usr_sta_state
        - usr_sta_employee_state
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        roles:
          type: array
          items:
            type: string
          description: "Lista de roles: admin, recepcionista, medico, paciente"
        usr_txt_password:
          type: string
          minLength: 8
          maxLength: 100
          description: "Must include uppercase, lowercase, number, and special character."
        usr_bol_email_verified:
          type: boolean
        usr_sta_state:
          type: integer
        usr_sta_employee_state:
          type: integer
      example:
        usr_txt_email: "juan.perez@correo.com"
        roles:
          - "admin"
        usr_txt_password: "Password#123"
        usr_bol_email_verified: false
        usr_sta_state: 1
        usr_sta_employee_state: 1
    UserResponse:
      type: object
      properties:
        usr_idt_id:
          type: integer
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        usr_bol_email_verified:
          type: boolean
        roles:
          type: array
          items:
            type: string
          description: "Lista de roles: admin, recepcionista, medico, paciente"
        usr_sta_state:
          type: integer
        usr_sta_employee_state:
          type: integer
        usr_dat_created_at:
          type: string
          format: date-time
        usr_dat_updated_at:
          type: string
          format: date-time
        date_deleted_at:
          type: string
          format: date-time
          nullable: true
      example:
        usr_idt_id: 10
        usr_txt_email: "juan.perez@correo.com"
        usr_bol_email_verified: true
        roles:
          - "paciente"
        usr_sta_state: 1
        usr_sta_employee_state: 1
        usr_dat_created_at: "2026-02-02T03:00:00.000Z"
        usr_dat_updated_at: "2026-02-02T03:00:00.000Z"
        date_deleted_at: null
    UpdateUserRequest:
      type: object
      properties:
        usr_txt_email:
          type: string
          format: email
          maxLength: 254
        roles:
          type: array
          items:
            type: string
          description: "Lista de roles: admin, recepcionista, medico, paciente"
        usr_txt_password:
          type: string
          minLength: 8
          maxLength: 100
          description: "Must include uppercase, lowercase, number, and special character."
        usr_bol_email_verified:
          type: boolean
        usr_sta_state:
          type: integer
        usr_sta_employee_state:
          type: integer
      example:
        usr_txt_email: "juan.perez@correo.com"
        usr_txt_password: "New#Password1"
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  uptime:
                    type: number
                  timestamp:
                    type: string
                    format: date-time
                  db:
                    type: string
                    example: "up"
        "503":
          description: Service Unavailable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "down"
                  uptime:
                    type: number
                  timestamp:
                    type: string
                    format: date-time
                  db:
                    type: string
                    example: "down"
  /auth/register:
    post:
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
            example:
              usr_txt_email: "juan.perez@correo.com"
              usr_txt_password: "Password#123"
      responses:
        "201":
          description: Created. Sensitive fields (password and verification/reset fields) are omitted in response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
              example:
                usr_idt_id: 10
                usr_txt_email: "juan.perez@correo.com"
                usr_bol_email_verified: false
                roles:
                  - "paciente"
                usr_sta_state: 2
                usr_sta_employee_state: 1
                usr_dat_created_at: "2026-02-02T03:00:00.000Z"
                usr_dat_updated_at: "2026-02-02T03:00:00.000Z"
                date_deleted_at: null
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "409":
          description: Email or DNI already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Email already exists"
        "500":
          description: Roles not configured
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Roles not configured"
  /auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            example:
              usr_txt_email: "juan.perez@correo.com"
              usr_txt_password: "Password#123"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid credentials"
        "403":
          description: Account not verified
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Account not verified"
  /auth/refresh:
    post:
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshTokenResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "401":
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid refresh token"
  /auth/logout:
    post:
      summary: Logout (revoke refresh token)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
  /auth/verify-email:
    post:
      summary: Verify email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyEmailRequest"
      responses:
        "200":
          description: Email verified
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Invalid or expired code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid verification code"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "User not found"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Too many requests"
  /auth/request-password-reset:
    post:
      summary: Request password reset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RequestPasswordResetRequest"
      responses:
        "200":
          description: If the email exists, a reset code is sent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Too many requests"
  /auth/reset-password:
    post:
      summary: Reset password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetPasswordRequest"
      responses:
        "200":
          description: Password updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Invalid or expired code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid reset code"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "User not found"
        "429":
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Too many requests"
  /users:
    post:
      summary: Create user (admin/receptionist)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
            example:
              usr_txt_email: "juan.perez@correo.com"
              roles:
                - "admin"
              usr_txt_password: "Password#123"
              usr_bol_email_verified: false
              usr_sta_state: 1
              usr_sta_employee_state: 1
      responses:
        "201":
          description: Created. Sensitive fields (password and verification/reset fields) are omitted in response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
              example:
                usr_idt_id: 10
                usr_txt_email: "juan.perez@correo.com"
                usr_bol_email_verified: false
                roles:
                  - "admin"
                usr_sta_state: 1
                usr_sta_employee_state: 1
                usr_dat_created_at: "2026-02-02T03:00:00.000Z"
                usr_dat_updated_at: "2026-02-02T03:00:00.000Z"
                date_deleted_at: null
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Unauthorized"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Forbidden"
  /users/{id}:
    get:
      summary: Get user by id (admin/receptionist/doctor or self)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: OK. Sensitive fields (password and verification/reset fields) are omitted in response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
              example:
                usr_idt_id: 10
                usr_txt_email: "juan.perez@correo.com"
                usr_bol_email_verified: true
                roles:
                  - "paciente"
                usr_sta_state: 1
                usr_sta_employee_state: 1
                usr_dat_created_at: "2026-02-02T03:00:00.000Z"
                usr_dat_updated_at: "2026-02-02T03:00:00.000Z"
                date_deleted_at: null
        "400":
          description: Invalid id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid id"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Unauthorized"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Forbidden"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "User not found"
    put:
      summary: Update user (admin/receptionist)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
            example:
              usr_txt_email: "juan.perez@correo.com"
              usr_txt_password: "New#Password1"
      responses:
        "200":
          description: OK. Sensitive fields (password and verification/reset fields) are omitted in response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
              example:
                usr_idt_id: 10
                usr_txt_email: "juan.perez@correo.com"
                usr_bol_email_verified: true
                roles:
                  - "paciente"
                usr_sta_state: 1
                usr_sta_employee_state: 1
                usr_dat_created_at: "2026-02-02T03:00:00.000Z"
                usr_dat_updated_at: "2026-02-02T03:00:00.000Z"
                date_deleted_at: null
        "400":
          description: Invalid id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid id"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Unauthorized"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Forbidden"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "User not found"
    delete:
      summary: Soft delete user (admin)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: No Content
        "400":
          description: Invalid id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid id"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Unauthorized"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Forbidden"
  /:
    get:
      summary: Root health
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
